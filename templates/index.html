<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CourseConnect - Social Network per Corsisti</title>
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --accent-color: #f093fb;
            --success-color: #4facfe;
            --warning-color: #f6d365;
            --danger-color: #ff6b6b;
            --dark-bg: #1a1a1a;
            --card-bg: #2d2d2d;
            --text-light: #e0e0e0;
            --text-muted: #9ca3af;
            --border-color: #374151;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--dark-bg) 0%, #2d1b69 100%);
            color: var(--text-light);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Background Animation */
        .bg-animation { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; opacity: 0.1; }
        .floating-shapes { position: absolute; width: 100%; height: 100%; overflow: hidden; }
        .shape { position: absolute; background: linear-gradient(45deg, var(--primary-color), var(--secondary-color)); border-radius: 50%; animation: float 8s ease-in-out infinite; }
        .shape:nth-child(1) { width: 80px; height: 80px; left: 10%; animation-delay: 0s; }
        .shape:nth-child(2) { width: 120px; height: 120px; left: 70%; animation-delay: 2s; }
        .shape:nth-child(3) { width: 60px; height: 60px; left: 85%; animation-delay: 4s; }
        @keyframes float { 0%, 100% { transform: translateY(0) rotate(0); } 50% { transform: translateY(-20px) rotate(180deg); } }

        /* Glassmorphism Cards */
        .glass-card {
            background: rgba(45, 45, 45, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }
        .glass-card:hover { transform: translateY(-5px); box-shadow: 0 12px 40px rgba(0,0,0,0.4); }

        /* Navigation */
        .navbar { background: rgba(26,26,26,0.9) !important; backdrop-filter: blur(10px); border-bottom: 1px solid var(--border-color); padding: 1rem 0; }
        .navbar-brand { font-weight: 700; background: linear-gradient(45deg, var(--primary-color), var(--accent-color)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 1.5rem; }
        .nav-link { color: var(--text-light) !important; font-weight: 500; transition: color 0.3s ease; }
        .nav-link:hover { color: var(--primary-color) !important; }
        .navbar .navbar-toggler { border-color: rgba(255,255,255,.25); }
        .navbar .navbar-toggler:focus { box-shadow: 0 0 0 .15rem rgba(102,126,234,.35); }

        /* Buttons */
        .btn-primary { background: linear-gradient(45deg, var(--primary-color), var(--secondary-color)); border: none; padding: 0.75rem 2rem; border-radius: 10px; font-weight: 600; transition: all 0.3s ease; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(102,126,234,0.3); }
        .btn-outline-primary { color: var(--primary-color); border-color: var(--primary-color); background: transparent; }
        .btn-outline-primary:hover { background: var(--primary-color); border-color: var(--primary-color); color: #fff; }

        /* Hero Section */
        .hero-section { padding: 4rem 0; text-align: center; }
        .hero-title { font-size: 3.5rem; font-weight: 700; margin-bottom: 1.5rem; background: linear-gradient(45deg, var(--primary-color), var(--accent-color)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .hero-subtitle { font-size: 1.25rem; color: var(--text-muted); margin-bottom: 2rem; max-width: 600px; margin-left: auto; margin-right: auto; }

        /* Forms */
        .form-control, .form-select { background: rgba(45,45,45,0.7); border: 1px solid var(--border-color); color: var(--text-light); border-radius: 10px; padding: 0.75rem 1rem; }
        .form-control:focus, .form-select:focus { background: rgba(45,45,45,0.9); border-color: var(--primary-color); color: var(--text-light); box-shadow: 0 0 0 0.2rem rgba(102,126,234,0.25); }
        .form-control::placeholder { color: var(--text-muted); }
        .form-select option { background: var(--card-bg); color: var(--text-light); }

        /* Validation */
        .is-invalid { border-color: var(--danger-color) !important; box-shadow: 0 0 0 0.2rem rgba(255,107,107,0.25) !important; }
        .is-valid { border-color: var(--success-color) !important; box-shadow: 0 0 0 0.2rem rgba(79,172,254,0.25) !important; }
        .invalid-feedback { color: var(--danger-color); font-size: 0.875rem; margin-top: 0.25rem; }
        .valid-feedback { color: var(--success-color); font-size: 0.875rem; margin-top: 0.25rem; }

        /* Modals */
        .modal-content { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 16px; }
        .modal-header { border-bottom: 1px solid var(--border-color); }
        .modal-footer { border-top: 1px solid var(--border-color); }

        /* Alerts */
        .alert { border-radius: 10px; border: none; position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px; max-width: 400px; }
        .alert-success { background: linear-gradient(45deg, rgba(79,172,254,0.9), rgba(79,172,254,0.9)); color: #fff; border: 1px solid rgba(79,172,254,0.3); }
        .alert-danger { background: linear-gradient(45deg, rgba(255,107,107,0.9), rgba(255,107,107,0.9)); color: #fff; border: 1px solid rgba(255,107,107,0.3); }

        /* Posts */
        .post-card { margin-bottom: 1.5rem; padding: 1.5rem; }
        .user-avatar { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; color: #fff; margin-right: 1rem; }
        .post-content { font-size: 1rem; line-height: 1.6; margin: 1rem 0; }
        .post-actions { display: flex; gap: 1rem; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color); }
        .action-btn { background: none; border: none; color: var(--text-muted); padding: 0.5rem 1rem; border-radius: 8px; transition: all 0.3s ease; cursor: pointer; }
        .action-btn:hover { color: var(--primary-color); background: rgba(102,126,234,0.1); }
        .action-btn.liked { color: var(--danger-color); }

        /* Loading */
        .loading { display: none; text-align: center; padding: 2rem; }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(102,126,234,0.3); border-top: 4px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Sidebar */
        .sidebar { background: rgba(45,45,45,0.4); border-radius: 16px; padding: 1.5rem; margin-bottom: 2rem; }
        .sidebar h5 { color: var(--primary-color); margin-bottom: 1rem; }

        /* Responsive */
        @media (max-width: 991.98px) {
            /* mostra hamburger e migliora la leggibilit√† del menu collassato */
            .navbar .navbar-collapse { 
                background: rgba(26,26,26,0.98); 
                border: 1px solid var(--border-color); 
                border-radius: 12px; 
                padding: .5rem 1rem; 
                margin-top: .75rem;
            }
            .navbar-nav .nav-link { padding: .5rem 0; }
        }

        @media (max-width: 768px) {
            .hero-title { font-size: 2.5rem; }
            .hero-subtitle { font-size: 1rem; }
            .post-card { padding: 1rem; }
        }

        /* Animations */
        .fade-in { animation: fadeIn 0.6s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .slide-up { animation: slideUp 0.4s ease-out; }
        @keyframes slideUp { from { transform: translateY(100px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>
    <!-- Background Animation -->
    <div class="bg-animation">
        <div class="floating-shapes">
            <div class="shape"></div>
            <div class="shape"></div>
            <div class="shape"></div>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-graduation-cap me-2"></i>CourseConnect
            </a>
            
            <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" 
                    aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <i class="fas fa-bars" style="font-size: 1.25rem;"></i>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item" id="nav-login">
                        <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#loginModal">
                            <i class="fas fa-sign-in-alt me-2"></i>Accedi
                        </a>
                    </li>
                    <li class="nav-item" id="nav-register">
                        <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#registerModal">
                            <i class="fas fa-user-plus me-2"></i>Registrati
                        </a>
                    </li>
                    <li class="nav-item" id="nav-user" style="display: none;">
                        <span class="nav-link">
                            <i class="fas fa-user me-2"></i>Ciao, <span id="user-name"></span>!
                        </span>
                    </li>
                    <li class="nav-item" id="nav-logout" style="display: none;">
                        <a class="nav-link" href="#" onclick="logout()">
                            <i class="fas fa-sign-out-alt me-2"></i>Logout
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-5 pt-5">
        <!-- Guest Section -->
        <div id="guest-section">
            <div class="hero-section fade-in">
                <h1 class="hero-title">
                    <i class="fas fa-graduation-cap me-3"></i>CourseConnect
                </h1>
                <p class="hero-subtitle">
                    Il social network dedicato ai corsisti. Connettiti, condividi e cresci insieme alla community di apprendimento pi√π dinamica!
                </p>
                <div class="d-flex gap-3 justify-content-center flex-wrap">
                    <button class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#registerModal">
                        <i class="fas fa-rocket me-2"></i>Inizia Ora
                    </button>
                    <button class="btn btn-outline-primary btn-lg" data-bs-toggle="modal" data-bs-target="#loginModal">
                        <i class="fas fa-sign-in-alt me-2"></i>Accedi
                    </button>
                </div>
            </div>

            <div class="row mt-5">
                <div class="col-md-4 mb-4">
                    <div class="glass-card text-center p-4 h-100 fade-in">
                        <i class="fas fa-users fa-3x mb-3" style="color: var(--primary-color);"></i>
                        <h4>Community</h4>
                        <p>Connettiti con corsisti da tutta Italia, condividi esperienze e crea relazioni durature.</p>
                    </div>
                </div>
                <div class="col-md-4 mb-4">
                    <div class="glass-card text-center p-4 h-100 fade-in">
                        <i class="fas fa-lightbulb fa-3x mb-3" style="color: var(--accent-color);"></i>
                        <h4>Condivisione</h4>
                        <p>Condividi progetti, successi e sfide. Impara dagli altri e aiuta chi √® agli inizi.</p>
                    </div>
                </div>
                <div class="col-md-4 mb-4">
                    <div class="glass-card text-center p-4 h-100 fade-in">
                        <i class="fas fa-chart-line fa-3x mb-3" style="color: var(--success-color);"></i>
                        <h4>Crescita</h4>
                        <p>Accelera il tuo apprendimento attraverso feedback, collaborazioni e opportunit√†.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- User Section -->
        <div id="user-section" style="display: none;">
            <div class="row">
                <div class="col-lg-8">
                    <!-- Create Post -->
                    <div class="glass-card p-4 mb-4 slide-up">
                        <h5 class="mb-3">
                            <i class="fas fa-edit me-2"></i>Cosa stai imparando oggi?
                        </h5>
                        <div class="mb-3">
                            <textarea class="form-control" id="post-content" rows="3" 
                                    placeholder="Condividi i tuoi progressi, progetti o riflessioni..." 
                                    maxlength="2000"></textarea>
                            <div class="text-end mt-2">
                                <small class="text-muted">
                                    <span id="char-count">0</span>/2000 caratteri
                                </small>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="createPost()">
                            <i class="fas fa-paper-plane me-2"></i>Pubblica
                        </button>
                    </div>

                    <!-- Posts Feed -->
                    <div id="posts-container">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Caricamento post...</p>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <!-- Sidebar -->
                    <div class="sidebar glass-card">
                        <h5><i class="fas fa-fire me-2"></i>Corsisti Attivi</h5>
                        <div class="d-flex align-items-center mb-3">
                            <div class="user-avatar" style="background: #FF6B6B; width: 40px; height: 40px;">MR</div>
                            <div>
                                <div class="fw-bold">Marco Rossi</div>
                                <small class="text-muted">Sviluppo Web</small>
                            </div>
                        </div>
                        <div class="d-flex align-items-center mb-3">
                            <div class="user-avatar" style="background: #4ECDC4; width: 40px; height: 40px;">SB</div>
                            <div>
                                <div class="fw-bold">Sofia Bianchi</div>
                                <small class="text-muted">UI/UX Design</small>
                            </div>
                        </div>
                        <div class="d-flex align-items-center mb-3">
                            <div class="user-avatar" style="background: #45B7D1; width: 40px; height: 40px;">AC</div>
                            <div>
                                <div class="fw-bold">Admin CourseConnect</div>
                                <small class="text-muted">Amministratore</small>
                            </div>
                        </div>
                    </div>

                    <div class="sidebar glass-card">
                        <h5><i class="fas fa-star me-2"></i>Tips del Giorno</h5>
                        <p class="mb-2"><strong>üí° Coding:</strong> Usa console.log() per debuggare il JavaScript</p>
                        <p class="mb-2"><strong>üé® Design:</strong> I colori complementari creano contrasto efficace</p>
                        <p class="mb-0"><strong>üìà Marketing:</strong> A/B test per ottimizzare le conversioni</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-sign-in-alt me-2"></i>Accedi a CourseConnect
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="login-form">
                        <div class="mb-3">
                            <label for="login-username" class="form-label">Username</label>
                            <input type="text" class="form-control" id="login-username" required>
                        </div>
                        <div class="mb-3">
                            <label for="login-password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="login-password" required>
                        </div>
                        <div class="text-center">
                            <small class="text-muted">
                                üîß Test: admin/admin123 o marco_dev/password123
                            </small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
                    <button type="button" class="btn btn-primary" onclick="login()">
                        <i class="fas fa-sign-in-alt me-2"></i>Accedi
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Register Modal -->
    <div class="modal fade" id="registerModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-user-plus me-2"></i>Registrati su CourseConnect
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="register-form" novalidate>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="register-nome" class="form-label">Nome *</label>
                                    <input type="text" class="form-control" id="register-nome" required>
                                    <div class="invalid-feedback">Il nome √® obbligatorio</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="register-cognome" class="form-label">Cognome *</label>
                                    <input type="text" class="form-control" id="register-cognome" required>
                                    <div class="invalid-feedback">Il cognome √® obbligatorio</div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="register-username" class="form-label">Username *</label>
                                    <input type="text" class="form-control" id="register-username" required>
                                    <div class="invalid-feedback">L'username √® obbligatorio</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="register-email" class="form-label">Email *</label>
                                    <input type="email" class="form-control" id="register-email" required>
                                    <div class="invalid-feedback">Inserisci un'email valida</div>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="register-corso" class="form-label">Corso di Studio *</label>
                            <select class="form-select" id="register-corso" required>
                                <option value="">Seleziona il tuo corso...</option>
                                <option value="Sviluppo Web Full-Stack">Sviluppo Web Full-Stack</option>
                                <option value="UI/UX Design">UI/UX Design</option>
                                <option value="Digital Marketing">Digital Marketing</option>
                                <option value="Data Science">Data Science</option>
                                <option value="Mobile Development">Mobile Development</option>
                                <option value="Cybersecurity">Cybersecurity</option>
                                <option value="Cloud Computing">Cloud Computing</option>
                                <option value="Game Development">Game Development</option>
                                <option value="Web Design">Web Design</option>
                                <option value="Altro">Altro</option>
                            </select>
                            <div class="invalid-feedback">Seleziona un corso dal menu</div>
                        </div>
                        <div class="mb-3">
                            <label for="register-password" class="form-label">Password *</label>
                            <input type="password" class="form-control" id="register-password" required minlength="6">
                            <div class="form-text">Minimo 6 caratteri</div>
                            <div class="invalid-feedback">La password deve essere di almeno 6 caratteri</div>
                        </div>
                        <div class="mb-3">
                            <label for="register-bio" class="form-label">Bio (Opzionale)</label>
                            <textarea class="form-control" id="register-bio" rows="2" 
                                    placeholder="Raccontaci di te..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
                    <button type="button" class="btn btn-primary" onclick="register()" id="register-btn">
                        <i class="fas fa-user-plus me-2"></i>Registrati
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap & JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // State Management
        let currentUser = null;
        let posts = [];

        // Initialize App
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            setupEventListeners();
        });

        // Setup Event Listeners
        function setupEventListeners() {
            // Character counter for post
            const postContent = document.getElementById('post-content');
            if (postContent) {
                postContent.addEventListener('input', function() {
                    const charCount = document.getElementById('char-count');
                    if (charCount) { charCount.textContent = this.value.length; }
                });

                // Ctrl+Enter to post
                postContent.addEventListener('keydown', function(e) {
                    if (e.ctrlKey && e.key === 'Enter') { createPost(); }
                });
            }

            // Form validation listeners
            const formFields = [
                'register-nome', 'register-cognome', 'register-username', 
                'register-email', 'register-corso', 'register-password'
            ];

            formFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', () => validateField(field));
                    field.addEventListener('blur', () => validateField(field));
                }
            });
        }

        // Authentication Functions
        async function checkAuth() {
            try {
                const response = await fetch('/api/me');
                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.user;
                    showUserSection();
                    loadPosts();
                } else {
                    showGuestSection();
                }
            } catch (error) {
                console.error('Error checking auth:', error);
                showGuestSection();
            }
        }

        async function login() {
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value;

            if (!username || !password) {
                showAlert('Inserisci username e password', 'danger');
                return;
            }

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (response.ok) {
                    currentUser = data.user;
                    showAlert('Login effettuato con successo!', 'success');
                    closeModal('loginModal');
                    showUserSection();
                    loadPosts();
                } else {
                    showAlert(data.error || 'Errore durante il login', 'danger');
                }
            } catch (error) {
                showAlert('Errore di connessione', 'danger');
            }
        }

        function validateField(field) {
            const value = field.value.trim();
            let isValid = true;

            field.classList.remove('is-valid', 'is-invalid');

            switch (field.id) {
                case 'register-nome':
                case 'register-cognome':
                case 'register-username':
                    isValid = value.length >= 2; break;
                case 'register-email':
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/; isValid = emailRegex.test(value); break;
                case 'register-corso':
                    isValid = value !== ''; break;
                case 'register-password':
                    isValid = value.length >= 6; break;
            }

            field.classList.add(isValid ? 'is-valid' : 'is-invalid');
            return isValid;
        }

        function validateForm() {
            const fields = [ 'register-nome', 'register-cognome', 'register-username', 'register-email', 'register-corso', 'register-password' ];
            let isFormValid = true;
            fields.forEach(id => { const f = document.getElementById(id); if (!validateField(f)) isFormValid = false; });
            return isFormValid;
        }

        async function register() {
            if (!validateForm()) { showAlert('Correggi gli errori nel form prima di continuare', 'danger'); return; }

            const formData = {
                nome: document.getElementById('register-nome').value.trim(),
                cognome: document.getElementById('register-cognome').value.trim(),
                username: document.getElementById('register-username').value.trim(),
                email: document.getElementById('register-email').value.trim(),
                corso: document.getElementById('register-corso').value,
                password: document.getElementById('register-password').value,
                bio: document.getElementById('register-bio').value.trim()
            };

            const registerBtn = document.getElementById('register-btn');
            const originalText = registerBtn.innerHTML;
            registerBtn.disabled = true;
            registerBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Registrazione...';

            try {
                const response = await fetch('/api/register', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(formData)
                });
                const data = await response.json();
                if (response.ok) {
                    currentUser = data.user;
                    showAlert('üéâ Registrazione completata! Benvenuto in CourseConnect!', 'success');
                    closeModal('registerModal');
                    showUserSection();
                    loadPosts();
                } else {
                    showAlert(data.error || 'Errore durante la registrazione', 'danger');
                }
            } catch (error) {
                showAlert('Errore di connessione. Riprova.', 'danger');
            } finally {
                registerBtn.disabled = false;
                registerBtn.innerHTML = originalText;
            }
        }

        async function logout() {
            try {
                await fetch('/api/logout', { method: 'POST' });
                currentUser = null;
                showAlert('Logout effettuato', 'success');
                showGuestSection();
            } catch (error) { showAlert('Errore durante il logout', 'danger'); }
        }

        // UI Functions
        function showGuestSection() {
            document.getElementById('guest-section').style.display = 'block';
            document.getElementById('user-section').style.display = 'none';
            document.getElementById('nav-login').style.display = 'block';
            document.getElementById('nav-register').style.display = 'block';
            document.getElementById('nav-user').style.display = 'none';
            document.getElementById('nav-logout').style.display = 'none';
        }

        function showUserSection() {
            document.getElementById('guest-section').style.display = 'none';
            document.getElementById('user-section').style.display = 'block';
            document.getElementById('nav-login').style.display = 'none';
            document.getElementById('nav-register').style.display = 'none';
            document.getElementById('nav-user').style.display = 'block';
            document.getElementById('nav-logout').style.display = 'block';
            if (currentUser) { document.getElementById('user-name').textContent = currentUser.nome; }
        }

        // Posts Functions
        async function loadPosts() {
            const container = document.getElementById('posts-container');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Caricamento post...</p></div>';
            try {
                const response = await fetch('/api/posts');
                const data = await response.json();
                if (response.ok) { posts = data.posts; renderPosts(); }
                else { container.innerHTML = `<div class="alert alert-danger">Errore: ${data.error}</div>`; }
            } catch (error) {
                container.innerHTML = '<div class="alert alert-danger">Errore di connessione</div>';
            }
        }

        function renderPosts() {
            const container = document.getElementById('posts-container');
            if (posts.length === 0) {
                container.innerHTML = `
                    <div class="glass-card p-4 text-center">
                        <i class="fas fa-comments fa-3x mb-3" style="color: var(--text-muted);"></i>
                        <h5>Nessun post ancora</h5>
                        <p class="text-muted">Sii il primo a condividere qualcosa con la community!</p>
                    </div>
                `; return;
            }

            container.innerHTML = posts.map(post => `
                <div class="post-card glass-card slide-up">
                    <div class="d-flex align-items-start">
                        <div class="user-avatar" style="background: ${post.author.avatar_color}">
                            ${post.author.initials}
                        </div>
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h6 class="mb-0">${post.author.nome} ${post.author.cognome}</h6>
                                    <small class="text-muted">@${post.author.username} ‚Ä¢ ${post.author.corso}</small>
                                </div>
                                <small class="text-muted">${formatDate(post.created_at)}</small>
                            </div>
                            <div class="post-content">${post.content}</div>
                            <div class="post-actions">
                                <button class="action-btn ${post.is_liked ? 'liked' : ''}" onclick="toggleLike(${post.id})">
                                    <i class="fas fa-heart me-1"></i>
                                    <span id="likes-${post.id}">${post.likes_count}</span>
                                </button>
                                <button class="action-btn">
                                    <i class="fas fa-comment me-1"></i>
                                    ${post.comments_count}
                                </button>
                                <button class="action-btn">
                                    <i class="fas fa-share me-1"></i>
                                    Condividi
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function createPost() {
            const content = document.getElementById('post-content').value.trim();
            if (!content) { showAlert('Scrivi qualcosa prima di pubblicare!', 'danger'); return; }
            if (content.length > 2000) { showAlert('Il post √® troppo lungo (max 2000 caratteri)', 'danger'); return; }
            try {
                const response = await fetch('/api/posts', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ content }) });
                const data = await response.json();
                if (response.ok) {
                    document.getElementById('post-content').value = '';
                    document.getElementById('char-count').textContent = '0';
                    showAlert('Post pubblicato!', 'success');
                    loadPosts();
                } else { showAlert(data.error || 'Errore durante la pubblicazione', 'danger'); }
            } catch (error) { showAlert('Errore di connessione', 'danger'); }
        }

        async function toggleLike(postId) {
            try {
                const response = await fetch(`/api/posts/${postId}/like`, { method: 'POST' });
                const data = await response.json();
                if (response.ok) {
                    const likesSpan = document.getElementById(`likes-${postId}`);
                    const likeBtn = likesSpan.parentElement;
                    likesSpan.textContent = data.likes_count;
                    if (data.is_liked) likeBtn.classList.add('liked'); else likeBtn.classList.remove('liked');
                } else { showAlert(data.error || 'Errore', 'danger'); }
            } catch (error) { showAlert('Errore di connessione', 'danger'); }
        }

        // Utility Functions
        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);
            if (diff < 60) return 'Ora';
            if (diff < 3600) return Math.floor(diff / 60) + 'm';
            if (diff < 86400) return Math.floor(diff / 3600) + 'h';
            if (diff < 604800) return Math.floor(diff / 86400) + 'g';
            return date.toLocaleDateString('it-IT');
        }

        function showAlert(message, type) {
            document.querySelectorAll('.alert').forEach(a => a.remove());
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                <strong>${type === 'success' ? '‚úÖ' : '‚ùå'}</strong> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            setTimeout(() => { if (alertDiv && alertDiv.parentNode) alertDiv.remove(); }, 5000);
        }

        function closeModal(id) {
            const modal = bootstrap.Modal.getInstance(document.getElementById(id));
            if (modal) modal.hide();
        }

        // Add scroll animations
        window.addEventListener('scroll', function() {
            document.querySelectorAll('.glass-card').forEach(el => {
                const top = el.getBoundingClientRect().top;
                if (top < window.innerHeight - 150) el.classList.add('fade-in');
            });
        });
    </script>
</body>
</html>
